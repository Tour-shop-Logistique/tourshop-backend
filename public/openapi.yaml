openapi: 3.0.3
info:
  title: TourShop Backend API
  version: 1.0.0
  description: |
    API pour Tour Shop Logistique SARL.
    Documentation basée sur les endpoints fonctionnels.
servers:
  - url: http://localhost:8000
    description: Local dev
  - url: https://tourshop.nport.link
    description: Production (nport)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # ===== SCHEMAS DE REQUÊTE =====
    RegisterRequest:
      type: object
      required: [nom, prenoms, telephone, password, password_confirmation, type]
      properties:
        nom: { type: string, maxLength: 255 }
        prenoms: { type: string, maxLength: 255 }
        telephone: { type: string, description: "Format Côte d'Ivoire" }
        email: { type: string, format: email, maxLength: 255 }
        password: { type: string, minLength: 8 }
        password_confirmation: { type: string, minLength: 8 }
        type: { type: string, enum: [client, livreur, agence, backoffice] }

    LoginRequest:
      type: object
      required: [password, type]
      properties:
        telephone: { type: string, description: "Requis si email absent" }
        email:
          {
            type: string,
            format: email,
            description: "Requis si telephone absent",
          }
        password: { type: string }
        type:
          { type: string, enum: [client, livreur, admin, backoffice, agence] }

    AgenceSetupRequest:
      type: object
      required:
        [
          nom_agence,
          telephone,
          adresse,
          ville,
          commune,
          pays,
          latitude,
          longitude,
        ]
      properties:
        nom_agence: { type: string, maxLength: 255 }
        telephone: { type: string, maxLength: 20 }
        description: { type: string, maxLength: 1000 }
        adresse: { type: string, maxLength: 255 }
        ville: { type: string, maxLength: 255 }
        commune: { type: string, maxLength: 255 }
        pays: { type: string, maxLength: 255 }
        latitude: { type: number, minimum: -90, maximum: 90 }
        longitude: { type: number, minimum: -180, maximum: 180 }
        horaires:
          type: array
          items:
            type: object
            required: [jour, ouverture, fermeture]
            properties:
              jour:
                {
                  type: string,
                  enum:
                    [lundi, mardi, mercredi, jeudi, vendredi, samedi, dimanche],
                }
              ouverture:
                { type: string, pattern: "^([01]?[0-9]|2[0-3]):[0-5][0-9]$" }
              fermeture:
                { type: string, pattern: "^([01]?[0-9]|2[0-3]):[0-5][0-9]$" }

    CreateUserRequest:
      type: object
      required: [nom, prenoms, telephone, password, password_confirmation, type]
      properties:
        nom: { type: string, maxLength: 255 }
        prenoms: { type: string, maxLength: 255 }
        telephone: { type: string }
        email: { type: string, format: email, maxLength: 255 }
        password: { type: string, minLength: 8 }
        password_confirmation: { type: string, minLength: 8 }
        type: { type: string, enum: [livreur, agence, backoffice] }

    TarifBaseRequest:
      type: object
      required: [indice, mode_expedition, prix_zones]
      properties:
        indice: { type: number, minimum: 0, example: 2.0 }
        mode_expedition: { type: string, enum: [simple, groupage] }
        type_colis:
          {
            type: string,
            enum:
              [
                document,
                colis_standard,
                colis_fragile,
                colis_volumineux,
                produit_alimentaire,
                electronique,
                vetement,
                autre,
              ],
          }
        prix_zones:
          type: array
          items:
            type: object
            required:
              [zone_destination_id, montant_base, pourcentage_prestation]
            properties:
              zone_destination_id: { type: string, example: "Z1" }
              montant_base: { type: number, minimum: 0, example: 5000 }
              pourcentage_prestation:
                { type: number, minimum: 0, maximum: 100, example: 15 }

    TarifAgenceRequest: # Pour la création
      type: object
      required: [tarif_base_id, prix_zones]
      properties:
        tarif_base_id:
          type: string
          format: uuid
          description: "ID du tarif de base de référence"
          example: "550e8400-e29b-41d4-a716-446655440000"
        prix_zones:
          type: array
          minItems: 1
          description: "Zones avec pourcentages personnalisés par l'agence"
          items:
            type: object
            required: [zone_destination_id, pourcentage_prestation]
            properties:
              zone_destination_id:
                type: string
                description: "ID de la zone de destination"
                example: "Z1"
              pourcentage_prestation:
                type: number
                minimum: 0
                maximum: 100
                description: "Pourcentage de prestation appliqué par l'agence pour cette zone"
                example: 15.5

    TarifAgenceUpdateRequest: # Pour la mise à jour
      type: object
      properties:
        prix_zones:
          type: array
          minItems: 1
          description: "(Optionnel) Mettre à jour les zones et pourcentages."
          items:
            type: object
            required: [zone_destination_id, pourcentage_prestation]
            properties:
              zone_destination_id:
                type: string
                description: "ID de la zone de destination"
                example: "Z1"
              pourcentage_prestation:
                type: number
                minimum: 0
                maximum: 100
                description: "Nouveau pourcentage pour la zone"
                example: 20.0

    ZoneRequest:
      type: object
      required: [id, nom, pays]
      properties:
        id: { type: string, example: "Z1" }
        nom: { type: string, example: "Zone Locale" }
        pays:
          type: array
          items: { type: string }
          example: ["Côte d'Ivoire"]

    # ===== SCHEMAS DE RÉPONSE =====
    User:
      type: object
      properties:
        id: { type: string, format: uuid }
        nom: { type: string }
        prenoms: { type: string }
        telephone: { type: string }
        email: { type: string, format: email }
        type: { type: string, enum: [client, livreur, agence, backoffice] }
        actif: { type: boolean }
        agence_id: { type: string, format: uuid }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    Agence:
      type: object
      properties:
        id: { type: string, format: uuid }
        user_id: { type: string, format: uuid }
        nom_agence: { type: string }
        telephone: { type: string }
        description: { type: string }
        adresse: { type: string }
        ville: { type: string }
        commune: { type: string }
        pays: { type: string }
        latitude: { type: number }
        longitude: { type: number }
        horaires:
          type: array
          items:
            type: object
            properties:
              jour:
                {
                  type: string,
                  enum:
                    [lundi, mardi, mercredi, jeudi, vendredi, samedi, dimanche],
                }
              ouverture:
                { type: string, pattern: "^([01]?[0-9]|2[0-3]):[0-5][0-9]$" }
              fermeture:
                { type: string, pattern: "^([01]?[0-9]|2[0-3]):[0-5][0-9]$" }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    TarifBase:
      type: object
      properties:
        id: { type: string, format: uuid }
        indice: { type: number }
        mode_expedition: { type: string, enum: [simple, groupage] }
        type_colis: { type: string }
        prix_zones:
          type: array
          items:
            type: object
            properties:
              zone_destination_id: { type: string }
              montant_base: { type: number }
              pourcentage_prestation: { type: number }
              montant_prestation: { type: number }
              montant_expedition: { type: number }
        actif: { type: boolean }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    TarifAgence:
      type: object
      properties:
        id: { type: string, format: uuid }
        agence_id: { type: string, format: uuid }
        tarif_base_id: { type: string, format: uuid }
        prix_zones:
          type: array
          description: "Détails des prix par zone, incluant les calculs."
          items:
            type: object
            properties:
              zone_destination_id: { type: string }
              pourcentage_prestation:
                {
                  type: number,
                  description: "Pourcentage défini par l'agence.",
                }
              montant_base:
                {
                  type: number,
                  description: "Montant de base hérité du tarif de base.",
                }
              montant_prestation:
                {
                  type: number,
                  description: "Montant de la prestation calculé.",
                }
              montant_expedition:
                {
                  type: number,
                  description: "Montant total de l'expédition calculé.",
                }
        actif: { type: boolean }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    Zone:
      type: object
      properties:
        id: { type: string }
        nom: { type: string }
        pays: { type: array, items: { type: string } }
        actif: { type: boolean }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

paths:
  # ===== AUTHENTIFICATION =====
  /api/test-cors:
    get:
      tags: [System]
      summary: Test CORS
      responses:
        "200":
          description: Test CORS réussi
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  timestamp: { type: string }

  /api/register:
    post:
      tags: [Auth]
      summary: Inscription d'un utilisateur
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RegisterRequest" }
      responses:
        "201":
          description: Inscription réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  user: { $ref: "#/components/schemas/User" }
                  token: { type: string }

  /api/login:
    post:
      tags: [Auth]
      summary: Connexion utilisateur
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/LoginRequest" }
      responses:
        "200":
          description: Connexion réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  user: { $ref: "#/components/schemas/User" }
                  token: { type: string }

  /api/logout:
    post:
      tags: [Auth]
      summary: Déconnexion
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Déconnexion réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }

  /api/profil:
    get:
      tags: [Auth]
      summary: Profil utilisateur authentifié
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Profil récupéré
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  user: { $ref: "#/components/schemas/User" }

  # ===== AGENCE =====
  /api/agence/setup:
    post:
      tags: [Agence]
      summary: Configurer une nouvelle agence
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AgenceSetupRequest" }
      responses:
        "201":
          description: Agence créée avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  agence: { $ref: "#/components/schemas/Agence" }

  /api/agence/show:
    get:
      tags: [Agence]
      summary: Afficher les informations de l'agence
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Informations de l'agence récupérées
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  agence: { $ref: "#/components/schemas/Agence" }

  /api/agence/update:
    put:
      tags: [Agence]
      summary: Mettre à jour les informations de l'agence
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AgenceSetupRequest" }
      responses:
        "200":
          description: Agence mise à jour avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  agence: { $ref: "#/components/schemas/Agence" }

  # ===== GESTION UTILISATEURS AGENCE =====
  /api/agence/list-users:
    get:
      tags: [Agence - Users]
      summary: Lister les utilisateurs de l'agence
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Liste des utilisateurs récupérée
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  users:
                    type: array
                    items: { $ref: "#/components/schemas/User" }

  /api/agence/create-user:
    post:
      tags: [Agence - Users]
      summary: Créer un nouvel utilisateur pour l'agence
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateUserRequest" }
      responses:
        "201":
          description: Utilisateur créé avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  user: { $ref: "#/components/schemas/User" }

  /api/agence/show-user/{user}:
    get:
      tags: [Agence - Users]
      summary: Afficher un utilisateur spécifique
      security:
        - bearerAuth: []
      parameters:
        - name: user
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Utilisateur récupéré avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  user: { $ref: "#/components/schemas/User" }

  /api/agence/edit-user/{user}:
    put:
      tags: [Agence - Users]
      summary: Mettre à jour un utilisateur de l'agence
      security:
        - bearerAuth: []
      parameters:
        - name: user
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                nom: { type: string }
                prenoms: { type: string }
                telephone: { type: string }
                email: { type: string, format: email }
                password: { type: string, minLength: 8 }
                password_confirmation: { type: string, minLength: 8 }
                type: { type: string, enum: [livreur, agence, backoffice] }
      responses:
        "200":
          description: Utilisateur mis à jour avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  user: { $ref: "#/components/schemas/User" }

  /api/agence/status-user/{user}:
    put:
      tags: [Agence - Users]
      summary: Activer/désactiver un utilisateur
      security:
        - bearerAuth: []
      parameters:
        - name: user
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Statut utilisateur modifié avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  user: { $ref: "#/components/schemas/User" }

  # ===== TARIFICATION =====
  /api/tarification/list:
    get:
      tags: [Tarification]
      summary: Lister les tarifs de base
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Liste des tarifs récupérée
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  tarifs:
                    type: array
                    items: { $ref: "#/components/schemas/TarifBase" }

  /api/tarification/add-simple:
    post:
      tags: [Tarification]
      summary: Créer un tarif de base simple
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/TarifBaseRequest" }
      responses:
        "201":
          description: Tarif de base créé avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  tarif: { $ref: "#/components/schemas/TarifBase" }

  /api/tarification/edit-simple/{tarifBase}:
    put:
      tags: [Tarification]
      summary: Modifier un tarif de base simple
      security:
        - bearerAuth: []
      parameters:
        - name: tarifBase
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/TarifBaseRequest" }
      responses:
        "200":
          description: Tarif de base mis à jour avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  tarif: { $ref: "#/components/schemas/TarifBase" }

  /api/tarification/show/{tarifBase}:
    get:
      tags: [Tarification]
      summary: Afficher un tarif de base
      security:
        - bearerAuth: []
      parameters:
        - name: tarifBase
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Tarif de base récupéré
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  tarif: { $ref: "#/components/schemas/TarifBase" }

  /api/tarification/delete/{tarifBase}:
    delete:
      tags: [Tarification]
      summary: Supprimer un tarif de base
      security:
        - bearerAuth: []
      parameters:
        - name: tarifBase
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Tarif de base supprimé avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }

  /api/tarification/status/{tarifBase}:
    put:
      tags: [Tarification]
      summary: Activer/désactiver un tarif de base
      security:
        - bearerAuth: []
      parameters:
        - name: tarifBase
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Statut tarif modifié avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  tarif: { $ref: "#/components/schemas/TarifBase" }

  # ===== GESTION TARIFS AGENCE =====
  /api/agence/list-tarifs:
    get:
      tags: [Agence - Tarifs]
      summary: Lister les tarifs de l'agence
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Liste des tarifs de l'agence récupérée
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  tarifs:
                    type: array
                    items: { $ref: "#/components/schemas/TarifAgence" }

  /api/agence/add-tarif-simple:
    post:
      tags: [Agence - Tarifs]
      summary: Créer un nouveau tarif pour l'agence
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/TarifAgenceRequest" }
      responses:
        "201":
          description: Tarif d'agence créé avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  tarif: { $ref: "#/components/schemas/TarifAgence" }

  /api/agence/edit-tarif-simple/{tarif}:
    put:
      tags: [Agence - Tarifs]
      summary: Modifier un tarif de l'agence
      security:
        - bearerAuth: []
      parameters:
        - name: tarif
          in: path
          required: true
          schema: { type: string, format: uuid }
          description: "ID du tarif d'agence à modifier"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/TarifAgenceUpdateRequest" }
      responses:
        "200":
          description: Tarif d'agence mis à jour avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  tarif: { $ref: "#/components/schemas/TarifAgence" }

  /api/agence/show-tarif/{tarif}:
    get:
      tags: [Agence - Tarifs]
      summary: Afficher un tarif spécifique de l'agence
      security:
        - bearerAuth: []
      parameters:
        - name: tarif
          in: path
          required: true
          schema: { type: string, format: uuid }
          description: "ID du tarif d'agence à afficher"
      responses:
        "200":
          description: Tarif d'agence récupéré avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  tarif: { $ref: "#/components/schemas/TarifAgence" }

  /api/agence/delete-tarif/{tarif}:
    delete:
      tags: [Agence - Tarifs]
      summary: Supprimer un tarif de l'agence
      security:
        - bearerAuth: []
      parameters:
        - name: tarif
          in: path
          required: true
          schema: { type: string, format: uuid }
          description: "ID du tarif d'agence à supprimer"
      responses:
        "200":
          description: Tarif d'agence supprimé avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }

  /api/agence/status-tarif/{tarif}:
    put:
      tags: [Agence - Tarifs]
      summary: Activer/désactiver un tarif de l'agence
      security:
        - bearerAuth: []
      parameters:
        - name: tarif
          in: path
          required: true
          schema: { type: string, format: uuid }
          description: "ID du tarif d'agence dont modifier le statut"
      responses:
        "200":
          description: Statut du tarif d'agence modifié avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  tarif: { $ref: "#/components/schemas/TarifAgence" }

  # ===== ZONES =====
  /api/zones/list:
    get:
      tags: [Zones]
      summary: Lister les zones
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Liste des zones récupérée
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  zones:
                    type: array
                    items: { $ref: "#/components/schemas/Zone" }

  /api/zones/add:
    post:
      tags: [Zones]
      summary: Créer une nouvelle zone
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ZoneRequest" }
      responses:
        "201":
          description: Zone créée avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  zone: { $ref: "#/components/schemas/Zone" }

  /api/zones/show/{zone}:
    get:
      tags: [Zones]
      summary: Afficher une zone spécifique
      security:
        - bearerAuth: []
      parameters:
        - name: zone
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Zone récupérée avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  zone: { $ref: "#/components/schemas/Zone" }

  /api/zones/edit/{zone}:
    put:
      tags: [Zones]
      summary: Modifier une zone
      security:
        - bearerAuth: []
      parameters:
        - name: zone
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ZoneRequest" }
      responses:
        "200":
          description: Zone mise à jour avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  zone: { $ref: "#/components/schemas/Zone" }

  /api/zones/delete/{zone}:
    delete:
      tags: [Zones]
      summary: Supprimer une zone
      security:
        - bearerAuth: []
      parameters:
        - name: zone
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Zone supprimée avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }

  /api/zones/status/{zone}:
    put:
      tags: [Zones]
      summary: Activer/désactiver une zone
      security:
        - bearerAuth: []
      parameters:
        - name: zone
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Statut zone modifié avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  message: { type: string }
                  zone: { $ref: "#/components/schemas/Zone" }
